name: CI/CD for .NET Solution (Local Docker)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Chạy trên VPS Linux

    env:
      IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}
      DOCKER_PORT: ${{ secrets.DOCKER_PORT }}
      APP_PORT: ${{ secrets.APP_PORT }}
      APP_SECRET_ID: ${{ secrets.APP_SECRET_ID }}
      HOST_SECRET_PATH: ${{ secrets.HOST_SECRET_PATH }}
      DOCKER_SECRET_PATH: ${{ secrets.DOCKER_SECRET_PATH }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      
      - name: Set up environment for .NET installation
        run: |
          echo "DOTNET_ROOT=$HOME/.dotnet" >> $GITHUB_ENV
          echo "$HOME/.dotnet:$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Install .NET SDK in User Directory (if not installed)
        run: |
          if [ ! -d "$HOME/.dotnet" ]; then
            curl -fsSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --install-dir $HOME/.dotnet --version 8.0.100
          else
            echo ".NET SDK is already installed, skipping installation."
          fi

      - name: Verify .NET installation
        run: |
          echo "Dotnet path: $(which dotnet)"
          dotnet --version

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:v1 .

      - name: Stop and Remove Old Container (if exists)
        run: |
          docker stop $IMAGE_NAME || true
          docker rm $IMAGE_NAME || true

      - name: Run New Container
        run: |
          docker run -v $HOST_SECRET_PATH/secrets.json:$DOCKER_SECRET_PATH/$APP_SECRET_ID/secrets.json \
           -d --name $IMAGE_NAME -p $DOCKER_PORT:$APP_PORT $IMAGE_NAME:v1
